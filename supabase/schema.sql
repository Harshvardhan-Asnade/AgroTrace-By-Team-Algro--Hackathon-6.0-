-- Create the produce_lots table
CREATE TABLE IF NOT EXISTS public.produce_lots (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    origin TEXT NOT NULL,
    plantingDate TEXT NOT NULL,
    harvestDate TEXT NOT NULL,
    itemCount INTEGER NOT NULL,
    farmer JSONB NOT NULL,
    certificates JSONB,
    history JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Create the feedback table
CREATE TABLE IF NOT EXISTS public.feedback (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    lot_id TEXT NOT NULL,
    feedback_text TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Enable Row Level Security (RLS)
ALTER TABLE public.produce_lots ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.feedback ENABLE ROW LEVEL SECURITY;

-- Create Policies for produce_lots
-- Allow anyone to read the produce lot data (for public trace pages)
CREATE POLICY "Public read access for produce_lots" ON public.produce_lots FOR SELECT USING (true);
-- Allow authenticated users to insert new produce lots
CREATE POLICY "Allow authenticated users to insert produce_lots" ON public.produce_lots FOR INSERT TO authenticated WITH CHECK (true);
-- Allow authenticated users to update their own records
CREATE POLICY "Allow authenticated users to update produce_lots" ON public.produce_lots FOR UPDATE TO authenticated USING (true) WITH CHECK (true);

-- Create Policies for feedback
-- Allow anyone to read feedback
CREATE POLICY "Public read access for feedback" ON public.feedback FOR SELECT USING (true);
-- Allow anyone to insert feedback
CREATE POLICY "Allow all users to insert feedback" ON public.feedback FOR INSERT WITH CHECK (true);
